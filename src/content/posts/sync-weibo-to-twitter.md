---
title: 将微博同步至 Twitter
pubDate: 2020-09-20 22:44 PST
categories: ["随便聊聊"]
tags: AWS, IFTTT, Python, Twitter, 微博, Integromat
heroImage: /images/blog/weibo-twitter-sync.png
---

## 2021/02/15 更新

由于微博的原因，导致 IFTTT 从微博上抓取内容的 OAuth 接口无法使用，所以上述方法暂时失效了，并通过 IFTTT 客服了解到，因为联系不上微博方面修复这个问题，所以他们也不知道何时才能恢复。

## **正文**

本文需要一定的 Python 编程基础以及 AWS 使用经验。

因为同时拥有微博和推特账号，所以很多时候同一条内容既想发到两个平台上，又不想两个平台之间来回复制粘贴，之前尝试用 [IFTTT](https://ifttt.com/) 来做内容同步，即把一条新微博同步到推特上去，但效果不是很理想，比如说无法区分原创微博、转发微博和带图微博，这样导致三者同步过去的样子是一致的，要么都不带图，这样带图微博的图片就丢了，要么都带着图，纯文字微博的情况就直接放一张默认的『 image not found 』，要多难看有多难看，而转发微博会把整个转发链都搬上去，而里头的内容很可能没什么营养，除了污染推特粉丝的时间线没有任何用处。

后来在少数派上发现了一篇[文章](https://sspai.com/post/51942)，讲解如何用 IFTTT 配合 [Integromat](https://www.integromat.com/) 来分类微博内容，然后根据内容的类别发送不同的推特，而我们想要同步的一般只有原创纯文字微博和带图微博， Integromat 强大的分流机制能很好地完成这个简单的任务。然而这个方法也是有限制的，少数派上给出了一个列表，

> `&` 字符及其之后的文字内容无法同步，原因不明；
>
> 文字数超过 Twitter 限制（140）无法同步；
>
> 受制于微博接口限制，多图微博只同步第一张图片；
>
> 因为 Twitter 不支持显示微博表情包，建议使用输入法自带的表情符号。
>
> Integromat 免费额度每月仅有 1000 Operations，而一条原创微博消耗两次（转发微博消耗一次），故免费账户每月最多只能同步 500 条原创微博。

其实 Integromat 还有一条限制，免费版的套餐最快只能做到每 15 分钟同步一次，当然对于我们普通用户来说这不是个大问题，因为我们的时效性要求没那么高。前面四条跟微博或者推特平台自身的限制有关，作为用户几乎无计可施，所以本文的主要目的是为了解除最后一条限制，即如何用 AWS API Gateway + AWS Lambda 替换掉 Integromat ，整个过程如下图所示。

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="361px" viewBox="-0.5 -0.5 361 571" content="<mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2021-07-19T16:54:56.880Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.101 Safari/537.36 Edg/91.0.864.48&quot; etag=&quot;066rhYZCYf-Ct-fIISaV&quot; version=&quot;14.9.0&quot; type=&quot;google&quot;><diagram id=&quot;-ZAeIvJGfjhNFI5mR827&quot; name=&quot;Page-1&quot;>7Vptc6o4FP41fNQBAgIfRaF7Z+7O7Gw72+0nJ0KEbCNhQqy6v34TCArCrfaOVmZ725nKeckL53lOkpOqgdl698Bgnv5OY0Q0U493Gphrpml61kR8SM2+0hiGbVWahOFY6Y6KR/wvUkpdaTc4RkXLkVNKOM7byohmGYp4SwcZo9u224qS9qg5TFBH8RhB0tU+45inldY1naP+N4STtB7ZmHiVZQ1rZ/UmRQpjum2oQKCBGaOUV0/r3QwRGb06LlW78AfWw8QYyvglDdJFsApo9OI+PP+5eH2zotFfryOg5sb39QujWLy/EinjKU1oBklw1PqMbrIYyV51IR19vlOaC6UhlP8gzvcKTLjhVKhSvibKinaY/y2bj20lvTQs853quRT2tZBxtm80kuJL03ZsVkp1u26UVOAKumEReic0NdsgSxB/x8+s/GTcGgMoDB4QXSMxH+HAEIEcv7V5BRU9k4PfEUHxoED8AKCq3zdINmqkDsJH/GTItynm6DGHZSy2IovbWP0wfm+IcbR7942VFQCVAWoNcJW4PeaTUSdJ2siliX6jGLm/SH+GzGdJbw2K9GaH9N/Cp6enwTHf1O9NfcPoBOVTuW8OmfzWheT3BkV+o7vCfyqkzv8B0vq4ORBMreHt4ubEbq1loGctM+2eteywwF09Svb5KNENJzhDs0N1IOm0ohmfUUJZ6QPEbyhH9RMGY4xaNs+y56HZsM0xEx1hmgl7JvNG9ocJabSxp0D3Jb8LzugralhW5Y+wxLBID9knMcCi4vgOl4j8QQusul9Szum64TAlOJEGLnPUh0qKxKwQa+Mt31ClrmHWsoqKHBIWeRWOFd7JefiiOMmlcb1LZCE3htvCGjNU5de3SM7HF2L11PaCOV4kkKMt3F9p19TbuyYAdodpfUSzb8Wzye15FjpuoFsf49lct2eG82V4RuB6GcPrUMwCA6OYc55idejwuryyaMLQD9xZvIk0+DB6TcrNpI9A5WDTGsVeSNV85inn8k5mKgNhhlGcWWMsYFxhsU2xcSRGNMMYcig+pL4QnzmO+D5HoxVDaPQmuqVsVNsMkXUhjGNxvnHHeZZcY2FxTrYwq4s66EEd3Ow0bt/36Dbkk5t36cltWKWo10lkVYrqWuBo/lSbhlow0byJ5jpaYGvTueaVD67Q2KUm0Hzv/sc9o71CWs7dS9duUH4ly0n5cj5bnEFlSz3v3nSxNd/VphP54PmaHwwwSyx7cFkCvuRJgoi0LkYwi0dLJv5KlS0vRkLggMUzwku6kC7XPEyc1MPunU+QxhDvDE42Edu7e3pcUMu1iqbewq4RpU51RE5y5GD4yfLrtGLaomVJ9jHfYl71fFIXGvOpUd5ZtOvCjGboGphabd5Peu6B+ohv3QzSC2qne+8L9yf+4R2+KPHbdxM9/zz/OMbupyWCEI/fEyhtja9bgOA/</diagram></mxfile>" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://viewer.diagrams.net/?client=1&amp;page=0&amp;edit=_blank');}}})(this);" style="cursor:pointer;max-width:100%;max-height:571px;"><defs><linearGradient x1="0%" y1="100%" x2="0%" y2="0%" id="mx-gradient-945df2-1-5a30b5-1-s-0"><stop offset="0%" style="stop-color:#5A30B5"></stop><stop offset="100%" style="stop-color:#945DF2"></stop></linearGradient><linearGradient x1="0%" y1="100%" x2="0%" y2="0%" id="mx-gradient-f78e04-1-d05c17-1-s-0"><stop offset="0%" style="stop-color:#D05C17"></stop><stop offset="100%" style="stop-color:#F78E04"></stop></linearGradient></defs><g><path d="M 180 60 L 180 113.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 180 118.88 L 176.5 111.88 L 180 113.63 L 183.5 111.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="120" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><path d="M 180 180 L 180 213.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 180 218.88 L 176.5 211.88 L 180 213.63 L 183.5 211.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="120" y="120" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 150px; margin-left: 121px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">IFTTT</div></div></div></foreignObject><text x="180" y="154" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">IFTTT</text></switch></g><path d="M 117.5 340 L 117.5 365 L 60 365 L 60 383.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 60 388.88 L 56.5 381.88 L 60 383.63 L 63.5 381.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><path d="M 242.5 340 L 242.5 365 L 300 365 L 300 383.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 300 388.88 L 296.5 381.88 L 300 383.63 L 303.5 381.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="55" y="220" width="250" height="120" rx="18" ry="18" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><path d="M 90 255 L 140 255 L 140 305 L 90 305 Z" fill="url(#mx-gradient-945df2-1-5a30b5-1-s-0)" stroke="none" pointer-events="all"></path><path d="M 123.79 260.75 C 123.38 260.76 123.04 261.11 123.04 261.53 L 123.04 270.36 L 120.6 270.36 L 120.6 271.92 L 123.04 271.92 L 123.04 288.01 L 120.58 288.01 L 120.58 289.57 L 123.04 289.57 L 123.04 298.44 C 123.04 298.69 123.16 298.93 123.37 299.07 C 123.57 299.22 123.83 299.26 124.07 299.18 L 134.47 295.7 C 134.79 295.59 135 295.29 135 294.96 L 135 266.68 C 135 266.38 134.83 266.11 134.57 265.98 L 124.17 260.83 C 124.05 260.77 123.92 260.74 123.79 260.75 Z M 106.17 260.79 C 106.06 260.79 105.95 260.82 105.85 260.87 L 95.43 266.01 C 95.17 266.15 95 266.42 95 266.71 L 95 294.97 C 95 295.3 95.22 295.6 95.53 295.71 L 105.95 299.18 C 106.19 299.26 106.45 299.22 106.65 299.07 C 106.86 298.93 106.98 298.69 106.98 298.44 L 106.98 289.57 L 108.58 289.57 L 108.58 288.01 L 106.98 288.01 L 106.98 271.92 L 108.56 271.92 L 108.56 270.36 L 106.98 270.36 L 106.98 261.57 C 106.98 261.36 106.89 261.15 106.74 261.01 C 106.59 260.86 106.38 260.78 106.17 260.79 Z M 124.61 262.78 L 133.44 267.16 L 133.44 294.4 L 124.61 297.36 Z M 105.42 262.82 L 105.42 297.36 L 96.56 294.4 L 96.56 267.2 Z M 110.97 270.36 L 110.97 271.92 L 113.4 271.92 L 113.4 270.36 Z M 115.79 270.36 L 115.79 271.92 L 118.19 271.92 L 118.19 270.36 Z M 115.88 275 L 112.67 284.45 L 114.15 284.95 L 117.35 275.5 Z M 111.51 276.33 L 108.45 278.95 C 108.28 279.1 108.18 279.31 108.18 279.54 C 108.18 279.77 108.28 279.99 108.45 280.14 L 111.51 282.74 L 112.52 281.55 L 110.16 279.54 L 112.52 277.52 Z M 118.5 276.37 L 117.5 277.57 L 119.82 279.52 L 117.49 281.51 L 118.51 282.7 L 121.53 280.1 C 121.7 279.95 121.8 279.73 121.8 279.51 C 121.8 279.28 121.7 279.06 121.52 278.91 Z M 110.94 288.01 L 110.94 289.57 L 113.4 289.57 L 113.4 288.01 Z M 115.79 288.01 L 115.79 289.57 L 118.15 289.57 L 118.15 288.01 Z" fill="#ffffff" stroke="none" pointer-events="all"></path><path d="M 220 255 L 270 255 L 270 305 L 220 305 Z" fill="url(#mx-gradient-f78e04-1-d05c17-1-s-0)" stroke="none" pointer-events="all"></path><path d="M 233.02 260 C 232.59 260 232.24 260.35 232.24 260.78 L 232.24 269.6 C 232.24 270.03 232.59 270.38 233.02 270.38 L 238.92 270.38 L 252.88 299.56 C 253.01 299.83 253.29 300 253.59 300 L 263.44 300 C 263.87 300 264.22 299.65 264.22 299.22 L 264.22 290.4 C 264.22 289.97 263.87 289.62 263.44 289.62 L 259.94 289.62 L 246.03 260.45 C 245.9 260.17 245.63 260 245.33 260 Z M 233.8 261.56 L 244.84 261.56 L 258.74 290.73 C 258.87 291.01 259.15 291.18 259.45 291.18 L 262.66 291.18 L 262.66 298.44 L 254.08 298.44 L 240.12 269.27 C 239.99 269 239.72 268.82 239.41 268.82 L 233.8 268.82 Z M 237.5 275.58 C 237.19 275.58 236.91 275.75 236.78 276.03 L 225.9 298.87 C 225.78 299.11 225.8 299.4 225.94 299.63 C 226.08 299.85 226.33 299.99 226.6 299.99 L 236.97 299.99 C 237.27 299.99 237.55 299.82 237.68 299.55 L 243.43 287.53 C 243.53 287.31 243.53 287.06 243.43 286.85 L 238.19 276.03 C 238.06 275.76 237.79 275.59 237.5 275.58 Z M 237.49 278.17 L 241.86 287.19 L 236.48 298.43 L 227.84 298.43 Z" fill="#ffffff" stroke="none" pointer-events="all"></path><image x="164.5" y="264.5" width="30" height="30" xlink:href="https://cdn4.iconfinder.com/data/icons/pictype-free-vector-icons/16/add-128.png" preserveAspectRatio="none"></image><path d="M 60 450 L 60 503.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 60 508.88 L 56.5 501.88 L 60 503.63 L 63.5 501.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="0" y="390" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 420px; margin-left: 1px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">IFTTT 纯文字内容</div></div></div></foreignObject><text x="60" y="424" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">IFTTT 纯文字内容</text></switch></g><path d="M 300 450 L 300 503.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 300 508.88 L 296.5 501.88 L 300 503.63 L 303.5 501.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="240" y="390" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 420px; margin-left: 241px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">IFTTT 带图内容</div></div></div></foreignObject><text x="300" y="424" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">IFTTT 带图内容</text></switch></g><image x="154.5" y="4.5" width="50" height="50" xlink:href="https://cdn4.iconfinder.com/data/icons/logos-and-brands/512/373_Weibo_logo-128.png" preserveAspectRatio="none"></image><rect x="0" y="510" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><path d="M 35 554.2 C 40.3 554.89 46.21 553.37 50.18 550.3 C 45.95 550.19 42 547.81 40.61 543.8 C 42.35 544.14 43.86 544.02 45.23 543.63 C 41.43 542.86 37.1 539.9 36.98 534.3 C 38.55 535.12 40.2 535.51 41.69 535.49 C 37.73 533.09 35.49 528.12 38.49 522.89 C 43.76 529.14 52.1 532.49 59.62 532.77 C 58.72 528.46 60.58 524.58 64.56 522.48 C 69.32 520 74.38 521.55 77.15 524.21 C 79.27 523.85 81.44 523.12 83.67 521.89 C 82.67 524.31 81.31 525.87 79.1 527.14 C 80.81 526.91 82.63 526.65 85 525.64 C 83.68 527.48 81.93 529.12 79.89 530.48 C 80.43 539.8 75.01 548.94 67.88 553.5 C 58.06 559.73 45.1 560 35 554.2 Z" fill="#1da1f2" stroke="none" pointer-events="all"></path><rect x="240" y="510" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><path d="M 275 554.2 C 280.3 554.89 286.21 553.37 290.18 550.3 C 285.95 550.19 282 547.81 280.61 543.8 C 282.35 544.14 283.86 544.02 285.23 543.63 C 281.43 542.86 277.1 539.9 276.98 534.3 C 278.55 535.12 280.2 535.51 281.69 535.49 C 277.73 533.09 275.49 528.12 278.49 522.89 C 283.76 529.14 292.1 532.49 299.62 532.77 C 298.72 528.46 300.58 524.58 304.56 522.48 C 309.32 520 314.38 521.55 317.15 524.21 C 319.27 523.85 321.44 523.12 323.67 521.89 C 322.67 524.31 321.31 525.87 319.1 527.14 C 320.81 526.91 322.63 526.65 325 525.64 C 323.68 527.48 321.93 529.12 319.89 530.48 C 320.43 539.8 315.01 548.94 307.88 553.5 C 298.06 559.73 285.1 560 275 554.2 Z" fill="#1da1f2" stroke="none" pointer-events="all"></path></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"></g><a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank" rel="noopener"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

## 操作过程

因为很多步骤与少数派的文章是重合的，所以我就直接抄过来。

### 1. 设置 IFTTT

首先创建两个 Applet 分别负责发送纯文字推特和带图推特。

#### 纯文字内容

1. if this `Webhooks` --> Receive a web request --> Event Name: `only_text_weibo` --> Create trigger

3. then that `Twitter` --> Post a tweet --> Tweet text:`{{Value1}}`

5. Creat action

#### 带图内容

1. if this `Webhooks` --> Receive a web request --> Event Name: `image_text_weibo` --> Create trigger

3. then that `Twitter` --> Post a tweet with image --> Tweet text: `{{Value1}}` --> image URL: `{{Value2}}`

5. Creat action

然后点右上角自己的头像 -> My Services -> Webhooks -> Documentation ，在这个页面可以看到自己的 IFTTT key ，记录下来留待后用。

### 2. 设置 AWS

这里由 AWS API Gateway 提供一个 API endpoint ，用于接收从 IFTTT 发送过来的请求，后面用一个 Lambda 函数来进行具体的分流处理，用两者配合搭建 API 的详细过程记录在[这篇文章](https://old-panda.com/posts/lambda-api-gateway-note/)中，在此不再赘述。只需要接收的请求方法为 POST ，选择 HTTP API 还是 Restful API 并没有什么区别。然后将这一份[代码](https://github.com/OldPanda/sync-weibo-2-twitter)部署上线，这样 API Gateway + Lambda 的部分就完成了，其中包含了少数派文章中所描述的所有同步规则以及转发内容过滤规则。

注意在 `config.json` 文件中的两个 endpoint 要填入上一步中获得的 IFTTT key ，设置的 `token` 记好，下一步要用。

### 3. 设置 IFTTT

不要疑惑，标题没有写错，在这里我们需要设置第三个 Applet 来监听微博上的动静，然后触发在上一步中刚刚设置好的 API 。

1. if this：`Weibo`，选择 New post by you；

3. then that：`Webhook`，选择 Make a web request，URL 填写设置 Integromat 里面拿到的 Webhook 地址：`<your API Endpoint>`，Method 选择 `POST`，Content Type 选择 `application/x-www-form-urlencode`，Body 填写 `text={{Text}}&image={{PhotoURL}}&token=<your-token-used-in-code-config>`；

5. 点击 Create Action，点击 Finish

到此为止一个加强版的微博同步推特的工具就搭好了， AWS Lambda 自然是即时响应的，不必等待 15 分钟的发送队列，而限额呢？它每个月的免费额度是一百万次，也就是说可以同步一百万条微博，相当于没有限制。
