---
title: Bitcask 学习笔记
pubDate: 2020-08-23 16:40 PST
categories: ["聊聊技术"]
tags: Bitcask, Apache Kafka, Apache Zookeeper
heroImage: /images/blog/data-center-scaled.jpg
heroImageDescription: Photo by Taylor Vick on Unsplash
---

[Bitcask](https://github.com/basho/bitcask/blob/develop-3.0/doc/bitcask-intro.pdf) 是 [Basho 公司](https://riak.com/)设计研发的一款高性能键值数据库，基于日志文件的形式来管理数据，在设计文档中，他们声称实现了数据存储查询的『多快好省』，并且也有许多实践中的案例证明他们确实做到了这一点，例如，豆瓣自主研发的 [BeansDB](https://github.com/douban/beansdb) 也在很大程度上借鉴了 Bitcask 的设计思想（他们最近又用 [Go 重新实现](https://github.com/douban/gobeansdb)了一个版本），并用于他们线上服务。文档并不厚，只有简单的六页，所以花一点儿时间通读一遍，学习一下 Bitcask 的设计思路对研究开发自己的存储系统是大有裨益的。

在运行时 Bitcask 把所有数据存在硬盘上，每次写的时候就把数据追加到末尾，所以在性能上能达到媲美内存的速度。 Bitcask 会维护一个 file handler 指向当前正在写的文件，收到写请求就直接把数据追加在当前文件的末尾，而删除动作会写进去一个特殊标记，记录对应的 key 在这次操作中被删除。而读的时候，会根据在内存中维护的一个数据结构找到 key 在文件中的位置，只需要一次硬盘寻址就可以返回结果，从而在读写性能和数据持久化之间找到了一个平衡。

## 数据结构

### 文件数据结构

往硬盘文件上写数据时，数据结构的设计是必不可少的，基于此， Bitcask 才能在读写时返回正确的结果，并能确保数据的正确性。

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="990px" viewBox="-0.5 -0.5 990 241" content="<mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2020-08-23T23:02:52.796Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36 Edg/83.0.478.50&quot; etag=&quot;6ykhXUJJaSa-a6CR8geT&quot; version=&quot;13.6.4&quot; type=&quot;google&quot;><diagram id=&quot;gNLdh4J-VOy40syJ2TGN&quot; name=&quot;Page-1&quot;>3VlNW6MwEP41HPXhm/Zo1XUPu8+j9rDrMQspZAWCIbV0f/0mTSiQ9EttKXqSTCbT5J15ZybRcK6z6o6AIvmJI5gathlVhnNj2Lbl2j77wyVLIQnGrhDEBEVSqRFM0T8ohaaUzlEEy44ixTilqOgKQ5znMKQdGSAEL7pqM5x2f7UAMdQE0xCkuvQXimgipCM7aOTfIYqT+pctfyxmMlAry5OUCYjwoiVybg3nmmBMxVdWXcOUg1fjItZ92zK73hiBOT1kwcPDY2UvXiL0Mp89T6uL4HFGL6yRMPMK0rk8cUhCuWG6rFEgeJ5HkBuyDGeySBCF0wKEfHbB/M5kCc1SOa1vTO71FRIKq5ZIbvQO4gxSsmQq9exIgiajxgrkeNH4wKqBTVr4+1IGpNvjtekGGfYhwXkLUGMNKIoyWFKQFWeHyzGHBpftaqDAiBFLDjGhCY5xDtLbRjppYDPZqNH5gXEhwfoLKV3KLAHmFHehhBWiv/nyS0+OnqQx/n1TtQfLepCz87YW8eFTe65ZthrV67a6rcRzEsJd2EjQKSAxpLsUbaHIkdsZBgSmgKLXbsra5NPV0itCwLKlUGCU07Jl+Z4LmuhyVTK6SqJR9APf26XPPsQOmuhaH+UDAWdq/HyG/JQlD5ZzE9S1B0dQbzgEtQ4mqGO1KWpdmlawh6ar0T0kLFdTSD7O3boH2ctdZxDc9ZXKUAfUNu5aZp25Ny84EXlrQjXkFZ8Doa/nDo6+9uZ0d2agfH8/UOvWvh+gnG2hdWaoRsEBUI17hcrXoBLsM/FMg4udknYxASmKc/YdMkx4pp1wLBC7SV3JiQxFkSgjkNkFf1ameDqWSYzZ9SaGd8NtscpRiiJyJLiD0eZE2Ibb34C2fTK0gy+MtjdWgts+N9r6PVfvf/Loir8YsFGOc3gg4/cW+NaRvQ1HrmVv6wO0wq1eAUcKkqKzkYt2NACqHVexIxofzc7ROgH9mv21/GRZ/nEcpRnq2VOOfuHa5akwBWWJQuahkm2M6uJP5EOVI2pFfrcLVUOndqHedq8e/8wQs1TPH0Y/ex3yg80cafftZp91yNH79gPyWwTKZN2atsDn8ntAGfD5SmKbzopgBD+vX6s71+6DX8W2Yr/3hlw/lA6Eq7baiXhHKoxq3j41V/V7TI+BY/UQOAe/mPRVqNVL/3sjZ2/Jf3fosGHz/yOh3vwXzrn9Dw==</diagram></mxfile>" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://viewer.diagrams.net/?client=1');}}})(this);" style="cursor:pointer;max-width:100%;max-height:241px;"><defs></defs><g><rect x="0" y="130" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 160px; margin-left: 1px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">crc</div></div></div></foreignObject><text x="60" y="164" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">crc</text></switch></g><rect x="120" y="130" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 160px; margin-left: 121px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="180" y="164" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><path d="M 300 130 L 300 100 L 585 100 L 585 123.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 585 128.88 L 581.5 121.88 L 585 123.63 L 588.5 121.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="240" y="130" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 160px; margin-left: 241px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key size</div></div></div></foreignObject><text x="300" y="164" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key size</text></switch></g><path d="M 420 190 L 420 220 L 844 220 L 843.99 197.39" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 843.99 192.14 L 847.49 199.14 L 843.99 197.39 L 840.49 199.14 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="360" y="130" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 160px; margin-left: 361px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="420" y="164" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="480" y="130" width="210" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 160px; margin-left: 481px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="585" y="164" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="690" y="130" width="290" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 288px; height: 1px; padding-top: 160px; margin-left: 691px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value</div></div></div></foreignObject><text x="835" y="164" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value</text></switch></g><rect x="600" y="220" width="60" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 230px; margin-left: 630px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">size of</div></div></div></foreignObject><text x="630" y="234" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">size of</text></switch></g><rect x="410" y="80" width="60" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 90px; margin-left: 440px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">size of</div></div></div></foreignObject><text x="440" y="94" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">size of</text></switch></g><path d="M 120 40 L 120 0" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 980 40 L 980 0" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 126.37 20 L 973.63 20" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 121.12 20 L 128.12 16.5 L 126.37 20 L 128.12 23.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><path d="M 978.88 20 L 971.88 23.5 L 973.63 20 L 971.88 16.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="490" y="0" width="100" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 10px; margin-left: 540px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">crc coverage</div></div></div></foreignObject><text x="540" y="14" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">crc coverage</text></switch></g><path d="M 120 130 L 120 40" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="1 3" pointer-events="stroke"></path><path d="M 980 130 L 980 40" fill="none" stroke="#000000" stroke-miterlimit="10" stroke-dasharray="1 3" pointer-events="stroke"></path></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"></g><a transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487" target="_blank" rel="noopener noreferrer"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

一条数据的结构很简单，从图中可以看出，开头是对整个数据的校验值，用于保证文件中存的数据是正确的， timestamp 记录写入该数据时的时间，后面两个整型分别存储 key 和 value 的长度，再其后则为真正的 key 和 value 。 Bitcask 的文件内容即为多条这样的数据依次排列在硬盘上，每条新的数据直接追加到末尾。

在读的时候，只需要寻址到数据的位置，由于硬盘的预读机制，通常情况下只需要一次硬盘 IO 即可以获取整条数据并返回。

### 内存数据结构

硬盘的写问题解决了，还必须要有一个内存中的数据结构来记录一个 key 在文件的哪个位置，这样才能在查询的时候给出正确的值。

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="641px" viewBox="-0.5 -0.5 641 61" content="<mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2020-08-23T23:02:33.280Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36 Edg/83.0.478.50&quot; etag=&quot;gYq8lPRs-X1LOb94oApQ&quot; version=&quot;13.6.4&quot; type=&quot;google&quot;><diagram id=&quot;PZ5GOpZ3xPgFNZv7UvCq&quot; name=&quot;Page-1&quot;>zZZLc5swEMc/Dcd2eJnY12A7PbTTzvgQ99SRYQ1qgGXEEqCfvsJIBiInaWfaxCe0/32g/ekxsrwwb+8EK9MvGENmuXbcWt7acl3HdwP56ZVuUG5W/iAkgscqaBR2/Bco0VZqzWOoZoGEmBEv52KERQERzTQmBDbzsCNm87+WLAFD2EUsM9V7HlM6qEv3ZtQ/AU9S/WcnWA2enOlg1UmVshibieRtLC8UiDSM8jaErIenuQx522e854kJKOhPEmpywsUBG9hv3a/1AyvFin9QVR5ZVquG1WSp0wQSgXWpwkAQtJe4s4MOt815Oedu5TYBzIFEJ0NUoaXK6PSWUXYz4g60lk5QB0pjaoWTc+URghwoDpeZHLZhcLcImhCXh+jb0f+xvo8vMHmAzsAiqRQx9HUcy7ttUk6wK1nUext5FKSWUp4pt8nkxdV4itlkN4HjuG8JxzXgHLlEcsq6LkTaG5j76W2ReQYYiOUdo0wUlGKCBcs2o3o7orOlNcZ8RiwVsJ9A1KkLk9WEc5zQctpPxt/7Uh8Xylq3qvLJ6LRRyHb3U2OS1Ztj2snSeX+3dBXWIoLXzx8xkQC9vhV7mC9uBAEZI/44v9D/+Sr7xsEYhrLhfo2u8myc7953OxuLZ6mVWHHiWFwnOd9+b3KBQY54DhWxvLxOZAv3/yGT5viQOvkmz1Fv8xs=</diagram></mxfile>" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://viewer.diagrams.net/?client=1');}}})(this);" style="cursor:pointer;max-width:100%;max-height:61px;"><defs></defs><g><rect x="0" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 1px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="60" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="160" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 161px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">file id</div></div></div></foreignObject><text x="220" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">file id</text></switch></g><path d="M 120 30 L 153.63 30" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 158.88 30 L 151.88 33.5 L 153.63 30 L 151.88 26.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="280" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 281px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="340" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="400" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 401px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="460" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value position</text></switch></g><rect x="520" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 521px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="580" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"></g><a transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487" target="_blank" rel="noopener noreferrer"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

Bitcask 在内存中维护这样一个映射结构， key 对应的值有三者必不可少， file id 告诉 Bitcask 去哪个文件中去查询， value position 记录要找的 value 在文件的位置， value size 决定读取多长的字节。

与文件中的数据结构相结合，不难发现查询一个 key 过程为，

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="948px" viewBox="-0.5 -0.5 948 479" content="<mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2020-08-23T23:02:07.782Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36 Edg/83.0.478.50&quot; etag=&quot;yUwQRTDNjsYGslA9au_n&quot; version=&quot;13.6.4&quot; type=&quot;google&quot;><diagram id=&quot;f14fAj_aJmM_MbjDnlaz&quot; name=&quot;Page-1&quot;>7Z1bk9o2FIB/DTPtA4wlWb487iVJO5M0nUk72Tw64AU3BlNjskt/fWUkA+ZYFpuAdJjZPGSxsA3+dCR/kiUxYHfz53dlspx9KCZpPqDe5HnA7gdU/ONM/KlTNjIljH2ZMC2ziUwi+4RP2X+pSvRU6jqbpKvWjlVR5FW2bCeOi8UiHVettKQsi6f2bo9F3v7UZTJNQcKncZLD1M/ZpJrJ1IiG+/Tf0mw6az6ZBLF8Z540O6srWc2SSfF0kMTeDNhdWRSVfDV/vkvzGl7DRR73VvPu7ouV6aI65YAP8/B+Pf4rvYkePsd/T9nwj4ffh766ju9JvlZXrL5ttWkQTMtivVS7pWWVPneBT742u3vwi5Hd5Yo4SYt5WpUbsYs6UaCOUBFCGZfbT3veoa/2mR2wjtR+icri6e7MewrihQLxAigstgGlJz8gKmcsIuaMhcwGbdgM/bgVN0MSwsChcQcs5l0KFnUGS+ZTb+DYZeG7K0QyGzCxiNxVKJpC5I6FB1h8SzcAh6CxmKT1iciA3T7Nsir9tEzG9btPwjRE2qya5+ptLTYznsiIh/sj1tQsdggRQOgxE1y2hyHjpE4T0hGse+2Dg6UqnQibU5tFWc2KabFI8jf71Ns9QE9s7fd5XxRLhe2ftKo2Sk2TdVW0oabPWfVw8PpLfSqBQ27dP6szbzc2zcZCXO/D4cbBUfXm/rDtVnOcvL76on4k+wSZYl2O0xNKZ5WU07T3jBqnK9M8qbLv7e93/pyGViJfikus8wlnKSE0GEUdkmK/oPhafMtilVVZscCKMCIjioEgBwSrbJ6uqmS+RIpOtKtGAQp2gdmG2rWyAZm4O+Z3RV6UYntRLNJTKfY3S4ek3b7gHkDHeIc57bouzg6OQ3UC4C7dWCekBYV4kIpdn+TQli4ApSc/ELk1h+1Ph27NNZHksu7hUBycu7WOEyq35j7A8+rWrQrI6NZN6TS6Ndf05dhxaw7VBoNbG0oJGrfm0G6wuLUJIRK35vCZhHO3NqBD49bcSk/jyxTRd66I7rqiubl/0S6LALYhXCqiuXfaehEKEHa/6jihUsQAlqpXRWxVQEZFbEqnUREDp92vAc7uV0MpQaOIAd7uVxNCJIoYIOx+NaBDo4jBCd2vthUxcq2IgZVxUD35gUkRYRvCoSIG5hFR9osQbFA4V0QdJ1SKGHoAz6sitiogsyKq0mlWRM39yI4ihrAVhUERDaUEjSKGVIvPtSKaECJRxBC2UZwrogEdGkUMYQPlAjb0IkXcncGZFoWwzXEBKD35gUgRQ9iGcKiIMmdwKWIIGxTOFVHHCZciRgDPqyK2KiCjIjal06iIoeZ+ZEkRYSsKgyIaSgkaRWz6TBAqogkhEkWMYBvFuSIa0KFRxAiBIg6bQ5Qjshg6Iu8aoklodCEsxAqWnhzptyCvSxLppVi4mzpIsLGANjgux67qGGKeKxiIGpr6fhSHMY9JxJqHBlZgwf5n59WyDtlzPy4sRKFpbZtrTj3LgJRQOjrE1fTnYEFK9PqFmWrERgKlH8QsCkPejF1FAxUamcN+BQNLQWl0GJ8+LPTEC0fEpxEPm/9twqS6CEWJk3E68nwvIgGjAWceh5ZL/HB0gDtmoU2cVp6bv0jtNu1LNmnv5dDg0hvzA3W3lRxGv9EwuxK/ISgFp58pdsGhSAXHQBW34FBcgtPPshacGN6EGR8Rm8iwaUw/NNYxlo3Ewlushpm7rheDqzRjX531xFD4GNehq1DkXTEUSq9zV9ExuxJXoVCW3buKgSl6V4FKjcFVTFSRu4pGqlGyxN4Zw6BND2iQi4+9fSzEhdd3XLmCiUj+d10vCipgsfrf4+NhUjCt/6rolicQX0ieQ76HNIdk/05nrlh1o+bE+NwohjFr140Y1EaHbiQvE68bMfis17kb6ZhdiRsxKOfu3cjAFLsbMf2CFJip4nYjppF4lCw1/TjUbj8O0zo6Smgs9Eaed/A4CgJ0+TQqOmE0+mqWLOuX402eCaIlNeP8Ktm//7pLSMbfptsc+biuxGlSlb6SI2lJPdj1Muvv7dRH2VHHMiKka9D7bj358zOHNenHXHAVSfdJlYg/b7dDvLXx7GwtQ87aLDthsg6Y/sVYwgr0SlmSjlGHllnCmvVaWbqPS9jpcTPejoXvh9nUtZNivJ5vr/7FVa0dxB1D1zsJN8Mvzj8W7YQFO9PF5Kb+8Zb65pUnq1U27rrr906hOGHxya6rVmknz4BQn/BnkW07cXZrx/pHFS47wikncajD9kTBmY6nwR2fR87xAOfZ5szusn8isyjIrHdp9cspXVdCnryurqutJ3d2XP0K4kCEfdXO+STPpos6LERGixqO3daFIxsn+Y16Y55NJnJOUCocRfXR1BXcsma0pcZvB/y+Pte6KhqPOU9hG5IjadktBnz4Ay5d0nKp+qzpU3IznWo/herLwTvWp1OdukJnM2nPOHEq+tm59dtDRRWXbA52UBGqrVXIUWXAVLDp6o7dfIgf3J947Cj+5Dc+bw0TvgboyQHajC0wBijVTCO6bIDSoyXTmd8fcMOju+RL9/dDz0KAOp2Q+kMBStzVoPGJASqV03oN2iwc1gRc2B9wwfEMsxfubydAYZOFgJC1alLt6D+HVx3dmbr6L6hNrdp53gF02Iy5Nn1twrt3XTa7mGFjkV095uNKpWtpE7uUYSsPLvd/bZT9o2BmHT/gcibMYnP/O66yWt//Gi578z8=</diagram></mxfile>" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://viewer.diagrams.net/?client=1');}}})(this);" style="cursor:pointer;max-width:100%;max-height:479px;"><defs></defs><g><rect x="158" y="20" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 35px; margin-left: 159px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="185" y="39" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="230.5" y="20" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 35px; margin-left: 232px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">file id</div></div></div></foreignObject><text x="258" y="39" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">file id</text></switch></g><path d="M 212.38 35 L 224.13 35" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 229.38 35 L 222.38 38.5 L 224.13 35 L 222.38 31.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="284.88" y="20" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 35px; margin-left: 286px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="312" y="39" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="339.25" y="20" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 35px; margin-left: 340px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="366" y="39" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value pos...</text></switch></g><rect x="393.63" y="20" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 35px; margin-left: 395px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="421" y="39" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="128" y="10" width="350" height="210" fill="none" stroke="#000000" pointer-events="all"></rect><rect x="158" y="60" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 75px; margin-left: 159px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="185" y="79" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="230.5" y="60" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 75px; margin-left: 232px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">file id</div></div></div></foreignObject><text x="258" y="79" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">file id</text></switch></g><path d="M 212.38 75 L 224.13 75" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 229.38 75 L 222.38 78.5 L 224.13 75 L 222.38 71.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="284.88" y="60" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 75px; margin-left: 286px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="312" y="79" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="339.25" y="60" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 75px; margin-left: 340px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="366" y="79" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value pos...</text></switch></g><rect x="393.63" y="60" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 75px; margin-left: 395px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="421" y="79" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="158" y="100" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 115px; margin-left: 159px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="185" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="230.5" y="100" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 115px; margin-left: 232px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">file id</div></div></div></foreignObject><text x="258" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">file id</text></switch></g><path d="M 212.38 115 L 224.13 115" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 229.38 115 L 222.38 118.5 L 224.13 115 L 222.38 111.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="284.88" y="100" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 115px; margin-left: 286px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="312" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="339.25" y="100" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 115px; margin-left: 340px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="366" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value pos...</text></switch></g><rect x="393.63" y="100" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 115px; margin-left: 395px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="421" y="119" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="158" y="140" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 155px; margin-left: 159px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="185" y="159" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="230.5" y="140" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 155px; margin-left: 232px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">file id</div></div></div></foreignObject><text x="258" y="159" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">file id</text></switch></g><path d="M 212.38 155 L 224.13 155" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 229.38 155 L 222.38 158.5 L 224.13 155 L 222.38 151.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="284.88" y="140" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 155px; margin-left: 286px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="312" y="159" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="339.25" y="140" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 155px; margin-left: 340px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="366" y="159" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value pos...</text></switch></g><rect x="393.63" y="140" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 155px; margin-left: 395px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="421" y="159" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="158" y="180" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 195px; margin-left: 159px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="185" y="199" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="230.5" y="180" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 195px; margin-left: 232px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">file id</div></div></div></foreignObject><text x="258" y="199" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">file id</text></switch></g><path d="M 212.38 195 L 224.13 195" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 229.38 195 L 222.38 198.5 L 224.13 195 L 222.38 191.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="284.88" y="180" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 195px; margin-left: 286px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="312" y="199" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="339.25" y="180" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 195px; margin-left: 340px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="366" y="199" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value pos...</text></switch></g><rect x="393.63" y="180" width="54.38" height="30" rx="4.5" ry="4.5" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 52px; height: 1px; padding-top: 195px; margin-left: 395px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="421" y="199" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="127" y="350" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 366px; margin-left: 128px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">crc</div></div></div></foreignObject><text x="158" y="370" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">crc</text></switch></g><rect x="188.22" y="350" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 366px; margin-left: 189px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="219" y="370" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="249.45" y="350" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 366px; margin-left: 250px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key size</div></div></div></foreignObject><text x="280" y="370" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key size</text></switch></g><rect x="310.67" y="350" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 366px; margin-left: 312px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="341" y="370" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="371.9" y="350" width="107.14" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 105px; height: 1px; padding-top: 366px; margin-left: 373px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="425" y="370" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="479.04" y="350" width="147.96" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 146px; height: 1px; padding-top: 366px; margin-left: 480px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value</div></div></div></foreignObject><text x="553" y="370" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value</text></switch></g><rect x="127" y="382" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 398px; margin-left: 128px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">crc</div></div></div></foreignObject><text x="158" y="402" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">crc</text></switch></g><rect x="188.22" y="382" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 398px; margin-left: 189px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="219" y="402" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="249.45" y="382" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 398px; margin-left: 250px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key size</div></div></div></foreignObject><text x="280" y="402" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key size</text></switch></g><rect x="310.67" y="382" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 398px; margin-left: 312px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="341" y="402" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="371.9" y="382" width="135.1" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 133px; height: 1px; padding-top: 398px; margin-left: 373px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="439" y="402" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="507" y="382" width="197.96" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 196px; height: 1px; padding-top: 398px; margin-left: 508px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value</div></div></div></foreignObject><text x="606" y="402" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value</text></switch></g><rect x="127" y="414" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 430px; margin-left: 128px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">crc</div></div></div></foreignObject><text x="158" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">crc</text></switch></g><rect x="188.22" y="414" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 430px; margin-left: 189px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="219" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="249.45" y="414" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 430px; margin-left: 250px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key size</div></div></div></foreignObject><text x="280" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key size</text></switch></g><rect x="310.67" y="414" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 430px; margin-left: 312px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="341" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="371.9" y="414" width="107.14" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 105px; height: 1px; padding-top: 430px; margin-left: 373px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="425" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="479.04" y="414" width="107.96" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 106px; height: 1px; padding-top: 430px; margin-left: 480px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; "><font color="#3333ff">value</font></div></div></div></foreignObject><text x="533" y="434" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value</text></switch></g><rect x="127" y="446" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 462px; margin-left: 128px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">crc</div></div></div></foreignObject><text x="158" y="466" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">crc</text></switch></g><rect x="188.22" y="446" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 462px; margin-left: 189px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="219" y="466" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="249.45" y="446" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 462px; margin-left: 250px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key size</div></div></div></foreignObject><text x="280" y="466" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key size</text></switch></g><rect x="310.67" y="446" width="61.22" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 59px; height: 1px; padding-top: 462px; margin-left: 312px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="341" y="466" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="371.9" y="446" width="125.1" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 123px; height: 1px; padding-top: 462px; margin-left: 373px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="434" y="466" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g><rect x="497" y="446" width="147.96" height="32" rx="4.8" ry="4.8" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 146px; height: 1px; padding-top: 462px; margin-left: 498px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value</div></div></div></foreignObject><text x="571" y="466" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value</text></switch></g><path d="M 647 15 C 647 6.72 689.53 0 742 0 C 767.2 0 791.36 1.58 809.18 4.39 C 826.99 7.21 837 11.02 837 15 L 837 245 C 837 253.28 794.47 260 742 260 C 689.53 260 647 253.28 647 245 Z" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><path d="M 837 15 C 837 23.28 794.47 30 742 30 C 689.53 30 647 23.28 647 15" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="677" y="200" width="130" height="40" fill="none" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 220px; margin-left: 678px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Older Data File</div></div></div></foreignObject><text x="742" y="224" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Older Data File</text></switch></g><rect x="677" y="150" width="130" height="40" fill="none" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 170px; margin-left: 678px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Older Data File</div></div></div></foreignObject><text x="742" y="174" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Older Data File</text></switch></g><rect x="677" y="100" width="130" height="40" fill="none" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 120px; margin-left: 678px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Older Data File</div></div></div></foreignObject><text x="742" y="124" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Older Data File</text></switch></g><path d="M 677 35 L 807 35 L 807 81.75 Q 774.5 66.9 742 81.75 Q 709.5 96.6 677 81.75 L 677 43.25 Z" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 54px; margin-left: 678px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">Active Data File</div></div></div></foreignObject><text x="742" y="58" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Active Data File</text></switch></g><path d="M 7 195 L 151.63 195" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 156.88 195 L 149.88 198.5 L 151.63 195 L 149.88 191.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="47" y="170" width="70" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 180px; margin-left: 82px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">Get(<font color="#0000ff">key</font>)</div></div></div></foreignObject><text x="82" y="184" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">Get(key)</text></switch></g><path d="M 257.69 210 L 257.7 260 L 537 260 L 537 62.5 L 670.63 62.5" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 675.88 62.5 L 668.88 66 L 670.63 62.5 L 668.88 59 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><path d="M 366.44 210 L 366.4 300 L 107 300 L 107 430 L 120.63 430" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 125.88 430 L 118.88 433.5 L 120.63 430 L 118.88 426.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><path d="M 312.06 210 L 312.1 330 L 767 330 L 767 430 L 593.37 430" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="stroke"></path><path d="M 588.12 430 L 595.12 426.5 L 593.37 430 L 595.12 433.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="all"></path><rect x="57" y="200" width="20" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 210px; margin-left: 67px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">1</div></div></div></foreignObject><text x="67" y="214" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">1</text></switch></g><rect x="517" y="140" width="20" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 150px; margin-left: 527px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">2</div></div></div></foreignObject><text x="527" y="154" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">2</text></switch></g><rect x="167" y="280" width="20" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 290px; margin-left: 177px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">3</div></div></div></foreignObject><text x="177" y="294" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">3</text></switch></g><rect x="617" y="310" width="20" height="20" fill="none" stroke="none" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 320px; margin-left: 627px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: nowrap; ">4</div></div></div></foreignObject><text x="627" y="324" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">4</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"></g><a transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487" target="_blank" rel="noopener noreferrer"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

在这个过程中，涉及到硬盘 IO 的只有第三步找到 value 的位置，因此它的查询效率是很高的。

## 文件管理

考虑到效率，如果一个文件过大，会造成更长的寻址时间，并且 Bitcask 把左右的写记录都放在文件中，如果不进行文件内容的维护，势必会造成大量的冗余数据，造成硬盘空间的浪费和读写效率的下降。

Bitcask 当然考虑到了这些问题，它会根据设置的文件大小自动进行文件的 rotate ，超过一定的大小，会冻结当前文件，将其转为只读模式，并打开一个新文件作为 active file ，之后的写请求都发生在这个新文件上。这样就能保证每个文件的大小不会超过设定的阈值。而至于数据冗余问题， Bitcask 会维护一个 merge 线程将冻结文件中的数据重新读一遍并留下最终的结果。

比如说在文件中有这样一串操作，

```
set foo bar
set foo baz
set hello world
set fake-key fake-value
del fake-key
del hello
```

在 merge 之后，产生的新文件的内容为，

```
set foo baz
```

`foo` 只保留最新值，而已经删掉的 `fake-key` 和 `hello` 则被直接删除。同时在 merge 之后会伴随着新生成的文件产生一个 hint 文件，顾名思义，里面包含着利于提高读取效率的数据，

<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="691px" viewBox="-0.5 -0.5 691 61" content="<mxfile host=&quot;app.diagrams.net&quot; modified=&quot;2020-08-23T23:24:57.950Z&quot; agent=&quot;5.0 (Macintosh; Intel Mac OS X 10_15_5) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/83.0.4103.97 Safari/537.36 Edg/83.0.478.50&quot; etag=&quot;tICezXZxizl9FpeNgqIp&quot; version=&quot;13.6.4&quot; type=&quot;google&quot;><diagram id=&quot;RnOzhYr3IgqVCspJBOeV&quot; name=&quot;Page-1&quot;>zZVBb4MgFIB/jcclFaxtj1vXdRdPJuvSG5E3JQOxSKvdr5/Op9a4Zlt2qCfhe48HfGBw6FqVW8OyJNAcpENmvHToo0OI6xG/+tTk3JDFymtAbATHpB6E4gMQzpAeBYd8kGi1llZkQxjpNIXIDhgzRhfDtDcth7NmLIYRCCMmx3QnuE0auiSLnj+DiJN2ZtdfNRHF2mTcSZ4wrosLRDcOXRutbdNS5RpkLa/10ox7uhLtFmYgtb8ZQHaHxT4IDmFcvO2C+5fX7Wl/h1VOTB5xw1YoyC1TGa7anlsVRh9TDnU116EPRSIshBmL6mhRHX7FEqskhrEuGAvl1QW7nYbq/oBWYM25SsEBSxSHN8dt+0V/Dm4rN7k4Ax8Zw6OPu8q9naqBgv4gi4xkvUO93ry+tbe2RWZT00VHuprmRIRRMjVh3lVhmc6FFTq9uTTPm5q0+fc/5Y09zf2fPXVv3D89Vd3+FfmKXbzFdPMJ</diagram></mxfile>" onclick="(function(svg){var src=window.event.target||window.event.srcElement;while (src!=null&amp;&amp;src.nodeName.toLowerCase()!='a'){src=src.parentNode;}if(src==null){if(svg.wnd!=null&amp;&amp;!svg.wnd.closed){svg.wnd.focus();}else{var r=function(evt){if(evt.data=='ready'&amp;&amp;evt.source==svg.wnd){svg.wnd.postMessage(decodeURIComponent(svg.getAttribute('content')),'*');window.removeEventListener('message',r);}};window.addEventListener('message',r);svg.wnd=window.open('https://viewer.diagrams.net/?client=1');}}})(this);" style="cursor:pointer;max-width:100%;max-height:61px;"><defs></defs><g><rect x="0" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 1px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">timestamp</div></div></div></foreignObject><text x="60" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">timestamp</text></switch></g><rect x="120" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 121px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key size</div></div></div></foreignObject><text x="180" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key size</text></switch></g><rect x="240" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 241px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value size</div></div></div></foreignObject><text x="300" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value size</text></switch></g><rect x="360" y="0" width="120" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 118px; height: 1px; padding-top: 30px; margin-left: 361px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">value position</div></div></div></foreignObject><text x="420" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">value position</text></switch></g><rect x="480" y="0" width="210" height="60" rx="9" ry="9" fill="#ffffff" stroke="#000000" pointer-events="all"></rect><g transform="translate(-0.5 -0.5)"><switch><foreignObject style="overflow: visible; text-align: left;" pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 30px; margin-left: 481px;"><div style="box-sizing: border-box; font-size: 0; text-align: center; "><div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: #000000; line-height: 1.2; pointer-events: all; white-space: normal; word-wrap: normal; ">key</div></div></div></foreignObject><text x="585" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">key</text></switch></g></g><switch><g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"></g><a transform="translate(0,-5)" xlink:href="https://desk.draw.io/support/solutions/articles/16000042487" target="_blank" rel="noopener noreferrer"><text text-anchor="middle" font-size="10px" x="50%" y="100%">Viewer does not support full SVG 1.1</text></a></switch></svg>

这样可以从 hint 文件直接构建内存中的数据结构，而不用再把新生成的文件再过一遍了。

## 小结

Bitcask 以其简洁的设计达到了低延迟高吞吐，并且能够处理比内存大得多的数据量，并且由于文件系统的存在，使得备份恢复非常容易，从中我们可以看到了 log 文件在其中发挥的作用，而充分利用文件系统的一个教科书级的大数据服务就是著名的 [Kafka](https://kafka.apache.org/)。作为个人的学习资料， Bitcask 是一个不可多得的范本。

Bitcask 当然也有它自己的问题，比如说不可避免的文件寻址，不能很方便地进行多机冗余备份，但在今天这样一个分布式的年代，将它部署到多机运行也不是太困难的事情，一个很直觉的想法是利用 [ZooKeeper](https://zookeeper.apache.org/) 或 [etcd](https://etcd.io/) 来管理 meta ，多个机器上的进程间就有了公共的可信信息源。业界肯定有更成熟的方案，这一部分我还没有去研究了解。
